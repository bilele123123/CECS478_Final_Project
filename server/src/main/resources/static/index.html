<!DOCTYPE html>
<html>
<head>
    <title>Chat MVP</title>
    <meta charset="UTF-8">

    <!-- SockJS + STOMP -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        /* Chat message display area */
        #messages {
            border: 1px solid #ccc;
            padding: 10px;
            height: 250px;
            overflow-y: auto;
            background: #fafafa;
        }
        .msg { margin-bottom: 8px; }
        .sender { font-weight: bold; }
    </style>
</head>
<body>

<h2>Realtime Chat</h2>

<!-- Username input and connect button -->
<input id="username" placeholder="Enter username" />
<button onclick="connect()">Connect</button>

<hr>

<!-- Chat UI (hidden until user connects) -->
<div id="chat" style="display:none;">
    <div id="messages"></div>
    
    <!-- Message input + send button -->
    <input id="messageInput" placeholder="Type a message..." />
    <button onclick="sendMessage()">Send</button>
</div>

<script>
    let stompClient = null;
    let jwtToken = null;
    /**
     * Connect the user to the STOMP WebSocket server.
     * 1. User enters a username
     * 2. The frontend fetches a JWT from /token
     * 3. Opens a SockJS connection
     * 4. Subscribes to /topic/messages to receive broadcast chat messages
     */
    async function connect() {
        const username = document.getElementById("username").value.trim();
        if (!username) {
            alert("Enter a username");
            return;
        }

        // Fetch JWT
        jwtToken = await fetch(`/token?username=${username}`)
            .then(res => res.text());

        console.log("JWT:", jwtToken);

        // Create SockJS connection
        const socket = new SockJS('/chat');
        stompClient = Stomp.over(socket);
        stompClient.debug = null; // Disable console spam

        // Attempt to connect, passing the JWT as a header
        stompClient.connect(
            { "X-Auth-Token": jwtToken },
            () => {
                console.log("Connected!");

                // Show the chat interface
                document.getElementById("chat").style.display = "block";

                // Subscribe to backend message broadcasts
                stompClient.subscribe("/topic/messages", msg => {
                    const payload = JSON.parse(msg.body);
                    appendMessage(payload.sender, payload.content);
                });
            },
            (err) => {
                console.error("Connection error:", err);
            }
        );
    }
    /**
     * Send a message through STOMP to backend endpoint /app/send-message.
     * Payload includes:
     *  - content: text user typed
     *  - timestamp: ISO time string
     */
    function sendMessage() {
        if (!stompClient) return;

        const text = document.getElementById("messageInput").value.trim();
        if (!text) return;

        const payload = {
            content: text,
            timestamp: new Date().toISOString(),
        };

        // Send message along with JWT header for authentication
        stompClient.send(
            "/app/send-message",
            { "X-Auth-Token": jwtToken },
            JSON.stringify(payload)
        );

        document.getElementById("messageInput").value = "";
    }
    
    /**
     * Display a chat message inside the #messages container.
     */
    function appendMessage(sender, content) {
        const container = document.getElementById("messages");

        const div = document.createElement("div");
        div.classList.add("msg");
        div.innerHTML = `<span class="sender">${sender}:</span> ${content}`;

        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }
</script>

</body>
</html>
